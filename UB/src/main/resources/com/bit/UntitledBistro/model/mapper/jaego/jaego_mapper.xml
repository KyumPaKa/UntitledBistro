<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="jaego">

	<select id="itemTotal" resultType="int">
		<![CDATA[
		SELECT 
			COUNT(SUM(ITEM_QTY)) 
		FROM 
			ITEM 
		GROUP BY 
			ITEM_PRODUCT_CODE
		]]>
	</select>
	<select id="productSelectAll" parameterType="condition" resultType="product">
		SELECT 
			 PRODUCT_CODE
			,PRODUCT_NAME
		FROM
			PRODUCT
		<where>
		<if test="keyword != '' and keyword != null">
			PRODUCT_CODE LIKE '%'||#{keyword}||'%'
		</if>
		<if test="keyword2 != '' and keyword2 != null">
		AND
			PRODUCT_NAME LIKE '%'||#{keyword2}||'%'
		</if>
		</where>
	
	</select>

 	<select id="itemSelectAll" parameterType="condition" resultType="item">
	    SELECT 
	         II.II_PRODUCT_CODE  					AS ITEM_PRODUCT_CODE
	        ,P.PRODUCT_NAME     					AS PRODUCT_NAME
	        ,NVL(II.II_QTY,0) - NVL(OI.OI_QTY,0)  	AS ITEM_QTY
	        ,ROWNUM AS RNUM
	    FROM
	    	(
	        SELECT 
	             II_PRODUCT_CODE
	            ,SUM(II_QTY) 			AS II_QTY
	        FROM 
	            IN_ITEM 
	        <where>
	        <if test="endDate != '' and endDate != null"> 
<![CDATA[		II_DATE <= TO_DATE(#{endDate}||' 23:59:59','YYYY/MM/DD HH24:MI:SS')]]>		
		    </if>
	        </where> 
	        GROUP BY 
	            II_PRODUCT_CODE
		    ) II
	    FULL OUTER JOIN
		    (
	        SELECT 
	             OI_PRODUCT_CODE
	            ,SUM(OI_QTY) 			AS OI_QTY
	        FROM 
	            OUT_ITEM
	        <where>
	        <if test="endDate != '' and endDate != null"> 
<![CDATA[		OI_DATE <= TO_DATE(#{endDate}||' 23:59:59','YYYY/MM/DD HH24:MI:SS')]]>		
		    </if>
	        </where>     
	        GROUP BY 
	            OI_PRODUCT_CODE
	    	) OI
	    ON
	        II.II_PRODUCT_CODE = OI.OI_PRODUCT_CODE
	    INNER JOIN
	        PRODUCT P
	    ON  
	        P.PRODUCT_CODE = II.II_PRODUCT_CODE
	    <where>
	    <if test="keyword != '' and keyword != null">
	        P.PRODUCT_CODE LIKE '%'||#{keyword}||'%'
	    </if>
	    <if test="keyword2 != '' and keyword2 != null">
	    AND
	        P.PRODUCT_NAME LIKE '%'||#{keyword2}||'%'
	    </if>
	    </where> 
	    ORDER BY ITEM_PRODUCT_CODE
		
 	</select>
 	
 	<select id="inItemSelectAll" parameterType="condition" resultType="inItem"> 	
 		SELECT 
		     /*+ INDEX_DESC(II PK_II_INDEX) */
		     II.II_PRODUCT_CODE			AS II_PRODUCT_CODE
		    ,P.PRODUCT_NAME				AS PRODUCT_NAME
		    ,II.II_QTY 					AS II_QTY 
		    ,II.II_DATE					AS II_DATE
		FROM 
		    IN_ITEM II
		INNER JOIN
		    PRODUCT P
		ON
		    II.II_PRODUCT_CODE = P.PRODUCT_CODE   
		<where>		
		<if test="keyword != '' and keyword != null">       
	        P.PRODUCT_CODE LIKE '%'||#{keyword}||'%'
	    </if> 
		<if test="keyword2!= '' and keyword2 != null">  
		AND     
	        P.PRODUCT_NAME LIKE '%'||#{keyword2}||'%'
	    </if> 
	    <if test="endDate != '' and endDate != null"> 
		AND 
<![CDATA[	II.II_DATE <= TO_DATE(#{endDate}||' 23:59:59','YYYY/MM/DD HH24:MI:SS')]]>		
	    </if>
		</where> 
		ORDER BY II_DATE DESC
 	</select>
 	
 	<select id="outItemSelectAll" parameterType="condition" resultType="outItem">
 		SELECT 
		     /*+ INDEX_DESC(O PK_OI_INDEX) */
		     OI.OI_PRODUCT_CODE			AS OI_PRODUCT_CODE
		    ,P.PRODUCT_NAME				AS PRODUCT_NAME
		    ,OI.OI_QTY 					AS OI_QTY
		    ,OI.OI_DATE					AS OI_DATE
		FROM 
		    OUT_ITEM OI
		INNER JOIN
		    PRODUCT P
		ON
		    OI.OI_PRODUCT_CODE = P.PRODUCT_CODE   
		<where>		
		<if test="keyword != '' and keyword != null">       
	        P.PRODUCT_CODE LIKE '%'||#{keyword}||'%'
	    </if> 
		<if test="keyword2 != '' and keyword2 != null">  
		AND     
	        P.PRODUCT_NAME LIKE '%'||#{keyword2}||'%'
	    </if> 
	    <if test="endDate != '' and endDate != null"> 
		AND 
<![CDATA[	OI.OI_DATE <= TO_DATE(#{endDate}||' 23:59:59','YYYY/MM/DD HH24:MI:SS')]]>		
	    </if>
		</where>
		ORDER BY OI_DATE DESC
 	</select>
	
	<!-- 
	==================================================================================
	================================= 재고변동표 =====================================
	==================================================================================
	 -->
 	<select id="changeItemSelectAll" parameterType="condition" resultType="changeItem">	  
		SELECT 
		        T.PRODUCT_CODE			AS PRODUCT_CODE 
		       ,T.PRODUCT_NAME			AS PRODUCT_NAME 
		       ,NVL(T.TOTAL_QTY,0)		AS TOTAL_QTY	
		       ,NVL(B.BEFORE_QTY,0)		AS BEFORE_QTY	
		       ,NVL(I.IN_QTY,0)			AS IN_QTY		
		       ,NVL(O.OUT_QTY,0)		AS OUT_QTY		
		FROM
		    (  
		    SELECT 
		         II.II_PRODUCT_CODE     				AS PRODUCT_CODE
		        ,P.PRODUCT_NAME         				AS PRODUCT_NAME
		        ,NVL(II.II_QTY,0) - NVL(OI.OI_QTY,0)  	AS TOTAL_QTY
		        
		    FROM
		    	(
		        SELECT 
		             II_PRODUCT_CODE
		            ,SUM(II_QTY)		AS II_QTY
		        FROM 
		            IN_ITEM 		            
		        <where> 
		        	<if test="endDate !='' and endDate != null">
<![CDATA[		    II_DATE <= TO_DATE(#{endDate}||' 23:59:59','YYYY/MM/DD HH24:MI:SS') ]]>
		        	</if>
		        </where>
		        GROUP BY 
		            II_PRODUCT_CODE
		    	) II
		    FULL OUTER JOIN
		   		(
		        SELECT 
		             OI_PRODUCT_CODE
		            ,SUM(OI_QTY)		AS OI_QTY
		        FROM 
		            OUT_ITEM 
		        <where> 
		        	<if test="endDate !='' and endDate != null">
<![CDATA[		    OI_DATE <= TO_DATE(#{endDate}||' 23:59:59','YYYY/MM/DD HH24:MI:SS') ]]>
		        	</if>
		        </where>
		        GROUP BY 
		            OI_PRODUCT_CODE
		    	) OI
		    ON
		        II.II_PRODUCT_CODE = OI.OI_PRODUCT_CODE
		    INNER JOIN
		        PRODUCT P
		    ON  
		        P.PRODUCT_CODE = II.II_PRODUCT_CODE
		    <where>
		    <if test="keyword != '' and keyword != null">
		        P.PRODUCT_CODE LIKE '%'||#{keyword}||'%'    
		    </if>
		    <if test="keyword2 != '' and keyword2 != null">
		     AND
		        P.PRODUCT_NAME LIKE '%'||#{keyword2}||'%'    
		    </if>
		    </where> 
		    ) T
		FULL OUTER JOIN
		    (
		    SELECT 
		         II.II_PRODUCT_CODE      			   AS PRODUCT_CODE
		        ,NVL(II.II_QTY,0) - NVL(OI.OI_QTY,0)   AS BEFORE_QTY
		    FROM
		    	(
		        SELECT 
		             II_PRODUCT_CODE
		            ,SUM(II_QTY)        AS II_QTY
		        FROM 
		            IN_ITEM
		        <where> 
		        	<if test="startDate !='' and startDate != null">
<![CDATA[		    II_DATE <= TO_DATE(#{startDate}||' 0:0:0','YYYY/MM/DD HH24:MI:SS') ]]>
		        	</if>
		        </where> 
		        GROUP BY 
		            II_PRODUCT_CODE
		    	) II
		    INNER JOIN
		   		(
		        SELECT 
		             OI_PRODUCT_CODE
		            ,SUM(OI_QTY) 		AS OI_QTY
		        FROM 
		            OUT_ITEM
		        <where> 
		        	<if test="startDate !='' and startDate != null">
<![CDATA[		    OI_DATE <= TO_DATE(#{startDate}||' 0:0:0','YYYY/MM/DD HH24:MI:SS') ]]>
		        	</if>
		        </where> 
		        GROUP BY 
		            OI_PRODUCT_CODE
		    	) OI
		    ON
		        II.II_PRODUCT_CODE = OI.OI_PRODUCT_CODE
		    INNER JOIN
		        PRODUCT P
		    ON  
		        P.PRODUCT_CODE = II.II_PRODUCT_CODE
		    <where>
		    <if test="keyword != '' and keyword != null">
		        P.PRODUCT_CODE LIKE '%'||#{keyword}||'%'
		    </if>
		    <if test="keyword2 != '' and keyword2 != null">
		    AND
		        P.PRODUCT_NAME LIKE '%'||#{keyword2}||'%'
		    </if>
		    </where> 
		    ) B
		ON 
		    T.PRODUCT_CODE = B.PRODUCT_CODE
		FULL OUTER JOIN
		    (
		    SELECT 
		         I.II_PRODUCT_CODE 		AS PRODUCT_CODE
		        ,NVL(SUM(II_QTY),0)    		AS IN_QTY
		    FROM 
		        IN_ITEM I
		    INNER JOIN
		        PRODUCT P
		    ON 
		        I.II_PRODUCT_CODE = P.PRODUCT_CODE
		    <where>
		    <if test="keyword != '' and keyword != null">
		        P.PRODUCT_CODE LIKE '%'||#{keyword}||'%'
		    </if>
		    <if test="keyword2 != '' and keyword2 != null">
		    AND
		        P.PRODUCT_NAME LIKE '%'||#{keyword2}||'%'
		    </if>
        	<if test="endDate !='' and endDate != null">
        	AND
<![CDATA[		I.II_DATE BETWEEN 
							TO_DATE(#{startDate}||' 0:0:0','YYYY/MM/DD HH24:MI:SS') 
						  AND 
						  	TO_DATE(#{endDate}||' 23:59:59','YYYY/MM/DD HH24:MI:SS') ]]>
        	</if>
		    </where>
		    GROUP BY 
		        I.II_PRODUCT_CODE
		    ) I
		ON
		    T.PRODUCT_CODE = I.PRODUCT_CODE
		FULL OUTER JOIN
		    (
		    SELECT 
		         O.OI_PRODUCT_CODE 		AS PRODUCT_CODE
		        ,NVL(SUM(O.OI_QTY),0)    		AS OUT_QTY
		    FROM 
		        OUT_ITEM O
		    INNER JOIN
		        PRODUCT P
		    ON
		        O.OI_PRODUCT_CODE = P.PRODUCT_CODE
		    <where>
		    <if test="keyword != '' and keyword != null">
		        P.PRODUCT_CODE LIKE '%'||#{keyword}||'%'
		    </if>
		    <if test="keyword2 != '' and keyword2 != null">
		    AND
		        P.PRODUCT_NAME LIKE '%'||#{keyword2}||'%'
		    </if>
        	<if test="endDate !='' and endDate != null">
        	AND
<![CDATA[		O.OI_DATE BETWEEN 
							TO_DATE(#{startDate}||' 0:0:0','YYYY/MM/DD HH24:MI:SS') 
						  AND 
						  	TO_DATE(#{endDate}||' 23:59:59','YYYY/MM/DD HH24:MI:SS') ]]>
        	</if>
		    </where>
		    GROUP BY 
		        O.OI_PRODUCT_CODE
		    ) O
		ON 
		    T.PRODUCT_CODE = O.PRODUCT_CODE
		ORDER BY PRODUCT_CODE
 	</select>

	<select id="defectItemSelectAll" parameterType="condition" resultType="defectItem">
		SELECT 
		     DI_PRODUCT_CODE
		    ,PRODUCT_NAME
		    ,DI_QTY
		    ,TO_CHAR(DI_DATE,'YYYY/MM/DD') 		AS DI_DATE
		    ,DI_STATE
		    ,DI_REASON
		FROM 
		    DEFECT_ITEM D
		INNER JOIN
		    PRODUCT P
		ON
		    D.DI_PRODUCT_CODE = P.PRODUCT_CODE
		<where>
		<if test="keyword != '' and keyword != null">
		    P.PRODUCT_CODE LIKE '%'||#{keyword}||'%'
		</if>
		<if test="keyword2 != '' and keyword2 != null">
		AND
		    P.PRODUCT_NAME LIKE '%'||#{keyword2}||'%'
		</if>
		<if test="endDate != '' and endDate != null">
		AND
<![CDATA[	DI_DATE <= TO_DATE(#{endDate}||' 23:59:59','YYYY/MM/DD HH24:MI:SS') ]]>
		</if>
		</where>
	</select>
 	
 	<!-- ================================================================================== -->
 	<!-- ===============================다중 등록========================================== -->
 	<!-- ================================================================================== -->
 	<insert id="defectItemInsert" parameterType="list">
		<selectKey  keyProperty="di_no" resultType="int" order="BEFORE">
			SELECT NVL(MAX(DI_NO),0) +1 FROM DEFECT_ITEM
		</selectKey>
		<foreach item="item" collection="list" open="INSERT ALL"  close="SELECT * FROM DUAL" separator=" " index="index">
		INTO DEFECT_ITEM
			(
			 DI_NO
			,DI_PRODUCT_CODE
			,DI_QTY
			,DI_STATE
			,DI_REASON
			) 
		VALUES 
			(
			 (#{di_no} + #{index})
			,#{item.di_product_code}
			,#{item.di_qty}
			,#{item.di_state}
			,#{item.di_reason}
			)
		</foreach>
 	</insert>
 	<insert id="safeItemInsert" parameterType="list">
		<selectKey  keyProperty="si_no" resultType="int" order="BEFORE">
			SELECT NVL(MAX(SI_NO),0) +1 FROM SAFE_ITEM
		</selectKey>
		<foreach item="item" collection="list" open="INSERT ALL"  close="SELECT * FROM DUAL" separator=" " index="index">
		INTO SAFE_ITEM
			(
			 SI_NO
			,SI_PRODUCT_CODE
			,SI_QTY
			) 
		VALUES 
			(
			 ((SELECT NVL(MAX(SI_NO),0) +1 FROM SAFE_ITEM) + #{index})
			,#{item.si_product_code}
			,#{item.si_qty}
			)
		</foreach>
 	</insert>
 	
 	<!-- 안전재고 조회 -->
 	<select id="safeItemSelectAll" resultType="safeItem">
 		SELECT
		     S.SI_PRODUCT_CODE
		    ,P.PRODUCT_NAME
		    ,S.SI_QTY
		FROM
		    SAFE_ITEM S
		INNER JOIN
		    PRODUCT P
		ON
	    	S.SI_PRODUCT_CODE = P.PRODUCT_CODE
 	</select>
 	
 	<!-- 재고현황과 안전재고 비교 -->
 	<select id="riskItemCount" parameterType="list" resultType="int">
 		SELECT
		      COUNT(I.ITEM_NO)
		FROM 
		    ITEM I
		INNER JOIN 
		    SAFE_ITEM S
		ON 
		    I.ITEM_PRODUCT_CODE = S.SI_PRODUCT_CODE
		<where>
		<foreach collection="list" item="item" separator=" ">
		OR	
<![CDATA[	I.ITEM_PRODUCT_CODE = #{item.si_product_code} AND I.ITEM_QTY <= #{item.si_qty} ]]>
		</foreach>
		</where>
 	</select>
 	
 	<!-- 재고현황과 안전재고 비교 -->
 	<select id="riskItemSelectAll" parameterType="list" resultType="risk">
 		SELECT
		       P.PRODUCT_CODE
		      ,P.PRODUCT_NAME
		      ,I.ITEM_QTY
		      ,S.SI_QTY
		FROM 
		    ITEM I
		INNER JOIN 
		    SAFE_ITEM S
		ON 
		    I.ITEM_PRODUCT_CODE = S.SI_PRODUCT_CODE
		INNER JOIN
			PRODUCT P
		ON 
			I.ITEM_PRODUCT_CODE = P.PRODUCT_CODE		    
		<where>
		<foreach collection="list" item="item" separator=" ">
		OR	
<![CDATA[	I.ITEM_PRODUCT_CODE = #{item.si_product_code} AND I.ITEM_QTY <= #{item.si_qty} ]]>
		</foreach>
		</where>
 	</select>
 	
	
<select id="safeItemValidate" parameterType="list" resultType="int">
	SELECT 
		COUNT(SI_NO) 
	FROM 
		SAFE_ITEM 
	<where>
	<foreach collection="list" item="item" separator=" ">
	OR
		SI_PRODUCT_CODE = #{item.si_product_code}
	</foreach>
	</where> 
</select> 	
 
</mapper>